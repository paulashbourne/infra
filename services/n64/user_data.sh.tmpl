#!/bin/bash
set -euo pipefail

dnf update -y
dnf install -y awscli nodejs tar gzip amazon-cloudwatch-agent

install -d -m 0755 /opt/n64-coordinator/server
install -d -m 0755 /etc/n64-coordinator
install -d -m 0755 /var/log/n64-coordinator

cat > /opt/n64-coordinator/server/multiplayerServer.mjs <<'JS'
import { createServer } from 'node:http';

const host = process.env.MULTIPLAYER_HOST ?? '0.0.0.0';
const port = Number(process.env.MULTIPLAYER_PORT ?? 8787);

const server = createServer((req, res) => {
  if (req.url === '/health') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ ok: true, service: 'n64-coordinator-bootstrap' }));
    return;
  }

  res.writeHead(503, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({
    error: 'Coordinator artifact not deployed yet. Run deploy-backend.sh to publish server code.',
  }));
});

server.listen(port, host, () => {
  console.log(`Bootstrap coordinator listening at http://$${host}:$${port}`);
});
JS

cat > /etc/n64-coordinator/env <<ENV
MULTIPLAYER_HOST=0.0.0.0
MULTIPLAYER_PORT=${coordinator_port}
AWS_REGION=${aws_region}
ARTIFACT_BUCKET=${artifact_bucket_name}
ENV

cat > /etc/systemd/system/n64-coordinator.service <<'SERVICE'
[Unit]
Description=Warpdeck 64 Multiplayer Coordinator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=ec2-user
Group=ec2-user
EnvironmentFile=/etc/n64-coordinator/env
WorkingDirectory=/opt/n64-coordinator
ExecStart=/usr/bin/node /opt/n64-coordinator/server/multiplayerServer.mjs
Restart=always
RestartSec=2
StandardOutput=append:/var/log/n64-coordinator/coordinator.log
StandardError=append:/var/log/n64-coordinator/coordinator.log

[Install]
WantedBy=multi-user.target
SERVICE

cat > /usr/local/bin/deploy-n64-coordinator <<'SCRIPT'
#!/bin/bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: deploy-n64-coordinator s3://bucket/key.tar.gz" >&2
  exit 1
fi

artifact_uri="$1"
workdir="$(mktemp -d)"
archive_path="$${workdir}/coordinator.tar.gz"

cleanup() {
  rm -rf "$${workdir}"
}
trap cleanup EXIT

aws s3 cp "$${artifact_uri}" "$${archive_path}"

rm -rf /opt/n64-coordinator
install -d -m 0755 /opt/n64-coordinator

tar -xzf "$${archive_path}" -C /opt/n64-coordinator
chown -R ec2-user:ec2-user /opt/n64-coordinator

systemctl daemon-reload
systemctl restart n64-coordinator
SCRIPT
chmod +x /usr/local/bin/deploy-n64-coordinator

cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<CWAGENT
{
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [
          {
            "file_path": "/var/log/n64-coordinator/coordinator.log",
            "log_group_name": "${coordinator_log_group_name}",
            "log_stream_name": "{instance_id}/coordinator",
            "timezone": "UTC"
          }
        ]
      }
    }
  }
}
CWAGENT

chown -R ec2-user:ec2-user /opt/n64-coordinator /var/log/n64-coordinator

/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a stop || true
/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config \
  -m ec2 \
  -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json \
  -s

systemctl daemon-reload
systemctl enable --now n64-coordinator
