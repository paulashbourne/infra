#!/bin/bash
set -euo pipefail

dnf update -y
dnf install -y awscli nodejs tar gzip amazon-cloudwatch-agent

hostnamectl set-hostname "${server_hostname}"

if [[ "${tailscale_enabled}" == "true" ]]; then
  cat > /etc/sysctl.d/99-tailscale-exit-node.conf <<'SYSCTL'
net.ipv4.ip_forward = 1
net.ipv6.conf.all.forwarding = 1
SYSCTL
  sysctl --system

  curl -fsSL https://pkgs.tailscale.com/stable/amazon-linux/2023/tailscale.repo -o /etc/yum.repos.d/tailscale.repo
  dnf install -y tailscale
  systemctl enable --now tailscaled

  tailscale_flags=(--ssh "--hostname=${server_hostname}")
  if [[ "${tailscale_advertise_exit_node}" == "true" ]]; then
    tailscale_flags+=(--advertise-exit-node)
  fi

  if [[ -n "${tailscale_auth_key}" ]]; then
    tailscale up --authkey="${tailscale_auth_key}" "$${tailscale_flags[@]}"
  else
    if ! tailscale up "$${tailscale_flags[@]}"; then
      echo "tailscale up could not complete unattended; provide tailscale_auth_key for first-time bootstrap."
    fi
  fi
fi

if [[ "${shared_proxy_enabled}" == "true" ]]; then
  dnf install -y nginx
  install -d -m 0755 /etc/paulnode/tenants-enabled
  install -d -m 0755 /var/log/paulnode

  cat > /etc/nginx/conf.d/paulnode-shared.conf <<'NGINX'
map $http_upgrade $connection_upgrade {
  default upgrade;
  ''      close;
}

server {
  listen ${shared_proxy_port};
  listen [::]:${shared_proxy_port};
  server_name _;

  access_log /var/log/paulnode/shared-proxy.access.log;
  error_log  /var/log/paulnode/shared-proxy.error.log warn;

  include /etc/paulnode/tenants-enabled/*.conf;

  location = /healthz {
    add_header Content-Type text/plain;
    return 200 'ok\n';
  }

  location / {
    return 404;
  }
}
NGINX

  cat > /etc/paulnode/tenants-enabled/10-n64.conf <<'NGINX'
location /api/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_set_header Connection "";
  proxy_pass http://127.0.0.1:${coordinator_port};
}

location /ws/ {
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection $connection_upgrade;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-Host $host;
  proxy_read_timeout 3600s;
  proxy_pass http://127.0.0.1:${coordinator_port};
}
NGINX

  cat > /usr/local/bin/paulnode-register-route <<'SCRIPT'
#!/bin/bash
set -euo pipefail

if [[ $# -ne 3 ]]; then
  echo "Usage: paulnode-register-route <name> <path-prefix> <upstream-url>" >&2
  echo "Example: paulnode-register-route notes /notes/ http://127.0.0.1:9001" >&2
  exit 1
fi

name="$1"
path_prefix="$2"
upstream_url="$3"

if [[ "$${path_prefix}" != /* ]]; then
  echo "path-prefix must start with /" >&2
  exit 1
fi

if [[ "$${path_prefix}" != */ ]]; then
  path_prefix="$${path_prefix}/"
fi

target="/etc/paulnode/tenants-enabled/$${name}.conf"

cat > "$${target}" <<EOF
location $${path_prefix} {
  proxy_http_version 1.1;
  proxy_set_header Host \$host;
  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto \$scheme;
  proxy_set_header X-Forwarded-Host \$host;
  proxy_set_header Upgrade \$http_upgrade;
  proxy_set_header Connection \$connection_upgrade;
  proxy_pass $${upstream_url};
}
EOF

nginx -t
systemctl reload nginx
echo "Route installed at $${target}"
SCRIPT
  chmod +x /usr/local/bin/paulnode-register-route
fi

install -d -m 0755 /opt/n64-coordinator/server
install -d -m 0755 /etc/n64-coordinator
install -d -m 0755 /var/log/n64-coordinator

cat > /opt/n64-coordinator/server/multiplayerServer.mjs <<'JS'
import { createServer } from 'node:http';

const host = process.env.MULTIPLAYER_HOST ?? '0.0.0.0';
const port = Number(process.env.MULTIPLAYER_PORT ?? 8787);

const server = createServer((req, res) => {
  if (req.url === '/health') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ ok: true, service: 'n64-coordinator-bootstrap' }));
    return;
  }

  res.writeHead(503, { 'Content-Type': 'application/json' });
  res.end(JSON.stringify({
    error: 'Coordinator artifact not deployed yet. Run deploy-backend.sh to publish server code.',
  }));
});

server.listen(port, host, () => {
  console.log(`Bootstrap coordinator listening at http://$${host}:$${port}`);
});
JS

cat > /etc/n64-coordinator/env <<ENV
MULTIPLAYER_HOST=0.0.0.0
MULTIPLAYER_PORT=${coordinator_port}
AWS_REGION=${aws_region}
ARTIFACT_BUCKET=${artifact_bucket_name}
BASIC_AUTH_EDGE_COOKIE_NAME=${basic_auth_cookie_name}
BASIC_AUTH_EDGE_COOKIE_TOKEN=${basic_auth_cookie_token}
BASIC_AUTH_EDGE_COOKIE_MAX_AGE_SECONDS=31536000
ENV

cat > /etc/systemd/system/n64-coordinator.service <<'SERVICE'
[Unit]
Description=Warpdeck 64 Multiplayer Coordinator
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=ec2-user
Group=ec2-user
EnvironmentFile=/etc/n64-coordinator/env
WorkingDirectory=/opt/n64-coordinator
ExecStart=/usr/bin/node /opt/n64-coordinator/server/multiplayerServer.mjs
Restart=always
RestartSec=2
StandardOutput=append:/var/log/n64-coordinator/coordinator.log
StandardError=append:/var/log/n64-coordinator/coordinator.log

[Install]
WantedBy=multi-user.target
SERVICE

if [[ "${shared_proxy_enabled}" == "true" ]]; then
  nginx -t
  systemctl enable --now nginx
fi

cat > /usr/local/bin/deploy-n64-coordinator <<'SCRIPT'
#!/bin/bash
set -euo pipefail

if [[ $# -ne 1 ]]; then
  echo "Usage: deploy-n64-coordinator s3://bucket/key.tar.gz" >&2
  exit 1
fi

artifact_uri="$1"
workdir="$(mktemp -d)"
archive_path="$${workdir}/coordinator.tar.gz"

cleanup() {
  rm -rf "$${workdir}"
}
trap cleanup EXIT

aws s3 cp "$${artifact_uri}" "$${archive_path}"

rm -rf /opt/n64-coordinator
install -d -m 0755 /opt/n64-coordinator

tar -xzf "$${archive_path}" -C /opt/n64-coordinator
chown -R ec2-user:ec2-user /opt/n64-coordinator

systemctl daemon-reload
systemctl restart n64-coordinator
SCRIPT
chmod +x /usr/local/bin/deploy-n64-coordinator

cat > /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json <<CWAGENT
{
  "logs": {
    "logs_collected": {
      "files": {
        "collect_list": [
          {
            "file_path": "/var/log/n64-coordinator/coordinator.log",
            "log_group_name": "${coordinator_log_group_name}",
            "log_stream_name": "{instance_id}/coordinator",
            "timezone": "UTC"
          }
        ]
      }
    }
  }
}
CWAGENT

chown -R ec2-user:ec2-user /opt/n64-coordinator /var/log/n64-coordinator

/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a stop || true
/opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
  -a fetch-config \
  -m ec2 \
  -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json \
  -s

systemctl daemon-reload
systemctl enable --now n64-coordinator
